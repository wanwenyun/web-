- [性能指标](#性能指标)
- [优化方案](#优化方案)
  - [网络相关](#网络相关)
  - [优化渲染过程](#优化渲染过程)
  - [文件优化](#文件优化)
  - [其他](#其他)
- [性能监控工具](#性能监控工具)

>https://alienzhou.github.io/fe-performance-journey/5-subresources/
>
>http://caibaojian.com/interview-map/frontend/performance.html

# 性能指标

|指标名|含义|优秀数据|
|--|--|--|
|FP|页面首个像素点渲染时间|1000ms以内|
|FCP|页面首次内容渲染时间|1000ms以内|
|LCP|最大内容渲染时间|2000ms以内|
|FID|用户首次和网站进行交互到浏览器响应该事件的实际延时时间|100ms以内|
|TTI|首次可交互时间||
|CLS|页面累计布局偏移总和|0.1以内|

# 优化方案

## 网络相关

- `DNS预解析`：DNS 解析也是需要时间的，可以通过预解析的方式来预先获得域名所对应的 IP。

  ```html
  <link rel="dns-prefetch" href="//yuchengkai.cn" />
  ```

- `缓存`：
  - 本地web存储
  - http缓存强缓存、协商缓存。
    > 详见《缓存 - 浏览器(http)缓存》章节。
    - 选择合适的缓存策略：
      - 对于某些不需要缓存的资源，可以使用 Cache-control: no-store ，表示该资源不需要缓存
      - 对于频繁变动的资源，可以使用 Cache-Control: no-cache 并配合 ETag 使用，表示该资源已被缓存，但是每次都会发送请求询问资源是否更新。
      - 对于代码文件来说，通常使用 Cache-Control: max-age=31536000 并配合策略缓存使用，然 后对文件进行指纹处理，一旦文件名变动就会立刻下载新的文件。
- `http/2.0`：在 HTTP / 2.0 中引入了多路复用，能够让多个请求使用同一个 TCP 链接，极大的加快了网页的加载速度。并且还支持 Header 压缩，进一步的减少了请求的数据大小。
  > 详见《网络(2) - http1、2、3》章节
- `预加载`：[Resource Hints1](https://www.w3.org/TR/resource-hints/) 是一种预加载相关的标准，它告诉浏览器哪些源下的资源我们的 Web 应用需要获取，哪些资源在之后的操作或浏览时需要被使用，从而让浏览器能够进行一些预先连接或预先加载操作。Resource Hints 标准包括 DNS Prefetch、Preconnect、Prefetch 与 Prerender。此外，还有一个与 Resource Hints 类似的 [Preload](https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/rel/preload)。
  
  ```html
  <link rel="preload" href="http://example.com" />
  ```
- `预渲染`：可以通过预渲染将下载的文件预先在后台渲染，可以使用以下代码开启预渲染
  
  ```html
  <link rel="prerender" href="http://example.com" />
  ```

## 优化渲染过程

- `懒执行`：懒执行就是将某些逻辑延迟到使用时再计算。该技术可以用于**首屏优化**，对于某些耗时逻辑并不需要在首屏就使用的，就可以使用懒执行。懒执行需要唤醒，一般可以通过定时器或者事件的调用来唤醒。
- `懒加载`：懒加载就是将不关键的资源延后加载。比如：只加载自定义区域（通常是可视区域，但也可以是即将进入可视区域）内需要加载的东西。
  - 对于图片来说，先设置图片标签的 src 属性为一张占位图，将真实的图片资源放入一个自定义属性中，当进入自定义区域时，就将自定义属性替换为 src 属性，这样图片就会去下载资源，实现了图片懒加载。

## 文件优化

- `图片加载优化`
  - 减少图片使用，用css替代
  - 小图使用base64格式，或SVG
  - 雪碧图
- `其他文件优化`
  - CSS 文件放在 head 中
  - 服务端开启文件压缩功能
  - 将 script 标签放在 **body 底部**，因为 JS 文件执行会阻塞渲染。或者把 script 标签放在任意位置然后加上 `defer` ，表示该文件会并行下载，但是会放到 HTML 解析完成后顺序执行。对于没有任何依赖的 JS 文件可以加上 `async` ，表示加载和渲染后续文档元素的过程将和 JS 文件的加载与执行并行无序进行。
  - `webworker`：执行 JS 代码过长会卡住渲染，对于需要很多时间计算的代码可以考虑使用 Webworker。`Webworker` 可以让我们另开一个线程执行脚本而不影响渲染。
- `CDN`：静态资源尽量使用 CDN 加载，由于浏览器对于单个域名有并发请求上限，可以考虑使用多个 CDN 域名。对于 CDN 加载静态资源需要注意 CDN 域名要与主站不同，否则每次请求都会带上主站的 Cookie。

## 其他

- 使用 `Webpack` 优化项目
  - 对于 Webpack4，打包项目使用 `production` 模式，这样会自动开启**代码压缩**
  - 使用 ES6 模块来开启 `tree shaking`，这个技术可以移除没有使用的代码
  - 优化图片，对于小图可以使用 `base64` 的方式写入文件中
  - 按照路由拆分代码，实现**按需加载**
  - 给打包出来的文件名添加哈希，实现浏览器**缓存**文件
- `监控`：一个合理的性能优化方案，一定是通过线上的性能监控数据，或者前端自动化性能测试分析，发现性能问题，针对发现的问题进行分析与定位，然后进行对应的性能优化，最后上线观察。之后又会进入到下一个性能优化的循环中。所以推行性能优化，一定要注重优化工程的可持续性。

# 性能监控工具

[lighthouse](https://github.com/GoogleChrome/lighthouse)

公司内部：rum