- [系统稳定：如何监控和保护进程安全？](#系统稳定如何监控和保护进程安全)
  - [监控告警](#监控告警)


# 系统稳定：如何监控和保护进程安全？

了解一个特点，在前端因为某些用户的特殊性，导致的逻辑 Bug 会造成这个用户服务异常，但是在服务端如果没有做好异常保护，因为某个用户的特殊操作可能会导致整个进程退出，从而无法提供服务，因此如何做好监控和进程安全保护就显得尤为重要。

**哪些场景会导致 Node.js 异常？**

- 由于 Node.js 使用的是 js 弱类型语言，因此在现网经常会引发一些由代码逻辑的异常导致的进程异常退出。
- 其次在 Node.js 中也经常会因为内存的使用不当，导致内存泄漏，当在 64 位系统中达到 1.4 G（32 位系统 0.7 G）时，Node.js 就会异常崩溃。
- 再而由于Node.js 的 I/O 较多也较为频繁，当启用较多 I/O 句柄，但是没有及时释放，同样会引发进程问题。

## 监控告警

在 Node.js 服务器中，监控告警一般会包含两部分：

- 自动定时采集进程的指标数据；
- 接口被调用或者访问后主动上报的信息。

监控数据处理经过一系列的复杂计算，按照一定的数据要求落入监控平台的数据存储中，告警平台则使用特定 QL 语法查询数据库，主要服务于三种类型：

- 触发告警，根据告警平台的设置，当数据落入后判断是否满足告警机制，满足则调用告警模块触发告警；
- 查询视图，这部分就是一个前端可交互的界面，用户可以在这个平台查询监控信息；
- API 接口，有些情况需要针对告警进行一些研发操作，因此也支持 API 来查询监控告警信息。

在 Node.js 进程方面我们要监控以下几个指标:

- **事件延迟**，因为 Node.js 主要是事件循环，如果主线程被长时间占用，就会导致事件执行有延迟，而最简单的办法就是使用 setTimeout 来判断。当我们设定 1000ms 执行某个事件，但是真正开始执行的时间大于 1000ms，那么我们就可能存在事件延迟了，而如果这个延迟越来越长，那么就必须进行告警提示开发者需要查看是否有异常事件被卡住，或者服务压力过大。
- **CPU 使用率**，这是一个非常重要的指标，当发现 CPU 使用率长期维持在 70% 以上，我们就要考虑是否需要扩容，或者是增加进程的方式来解决这个问题，如果长期在 100% 那么肯定是需要扩容，或者检查内部代码逻辑是否存在问题。
- **内存变化**，Node.js 的内存泄漏还是比较常见的，其最大的问题就是导致垃圾回收时间变长，从而影响 Node.js 的服务性能，最大的影响就是内存达到上限后进行重启，从而中断用户请求，引发在重启过程中的用户请求。
- **句柄变化**，由于服务器的句柄是有上限的，如果无节制地开启句柄，将会导致系统性能损耗，从而影响进程的性能，因此我们必须在未使用句柄时进行释放，而如果长期不释放就会在达到上限时，导致新的请求无法开启新的句柄，从而无法正常提供服务。
- **进程异常重启次数**，也是用来判断我们代码逻辑是否足够健壮的一个点，如果存在异常重启次数，那么一定是我们代码中存在未 catch 住的异常，或者说上面提到的内存泄漏上限问题。

接口需要上报的指标如下：
接口名称，接口请求时服务器时间，接口的请求用户分类标识，接口请求耗时，当前服务器 IP

